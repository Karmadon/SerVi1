<?php/** * Created by PhpStorm. * User: strem * Date: 30.08.2015 * Time: 17:01 */global $action,$actionAdd;if (isset($action)){	switch ($action)	{		case 'new':		{			$ownerID = $actionAdd;			if (isset ($_POST ['devicename']))			{				$device = new Device('POST', 0);				$device->createRecordInDB ();				Echo "<script> location.replace('/device/view/$device->id'); </script>";			}			$device = new Device('POST', 0);			$device->ownerID = $ownerID;			echo <<<HTML<div class = 'col-lg-10'>	<div class = 'panel panel-primary'>		<div class = 'panel-heading'>Данные устройства</div>		<div class = 'panel-body'>			<form method = 'post' class = 'form-horizontal' id = 'DeviceData' name = 'DeviceData' action = '/device/new/' accept-charset = 'utf-8'><div class = 'col-sm-12'>				<label for = 'deviceid'>ID Устройства</label>				<input name = 'deviceid' id = 'deviceid' disabled class = 'form-control' value = '$device->id'>				<p class = 'help-block'>Номер устройства, он же стикер на устройстве.</p></div><div class = 'col-sm-6'>				<label for = 'deviceid'>Название Устройства</label>				<input name = 'devicename' id = 'devicename' autocomplete = 'on' value = '$device->name' class = 'form-control' placeholder = 'Название Устройства (Для определения самого устройства в БД)' required>				<p class = 'help-block'>Название Устройства (Для определения самого устройства в БД).</p>				<label for = 'deviceid'>Изготовитель Устройства</label>				<input name = 'devicemanufac' id = 'devicemanufac' autocomplete = 'on' value = '$device->manufacturerSTR'				       class = 'form-control' placeholder = 'Производитель Устройства' required>				<p class = 'help-block'>Производителя можно выбрать из списка или добавить новый.</p></div><div class = 'col-sm-6'>				<label for = 'deviceid'>Модель устройства</label>				<input name = 'devicemodel' type = 'text' id = 'devicemodel' autocomplete = 'on' value = '$device->modelSTR'				       class = 'form-control' placeholder = 'Модель Устройства' required '>				<p class = 'help-block'>Модель можно выбрать из списка или добавить новый.</p>				<label for = 'deviceid'>Серийный номер устройства</label>				<input name = 'deviceserial' type = 'text' id = 'deviceserial' autocomplete = 'on'				       value = '$device->serial' class = 'form-control'				       placeholder = 'Серийный номер Устройства (полностью)' pattern = '^[0-9a-zA-Z]+$'>				<p class = 'help-block'>Серийный номер проверяется при каждом сохранении.</p></div><div class = 'col-sm-6'>				<label for = 'deviceid'>Тип Устройства</label>				<input name = 'devicetype' type = 'text' id = 'devicetype' value = '$device->typeSTR'				       class = 'form-control' placeholder = 'Тип устройства' required>				<p class = 'help-block'>Тип можно выбрать из списка или добавить новый.</p>				<label for = 'deviceid'>Категория устройства</label>				<input name = 'devicecategory' type = 'text' id = 'devicecategory' autocomplete = 'on'				       value = '$device->categorySTR' class = 'form-control' placeholder = 'Категория устройства'>				<p class = 'help-block'>Категорию можно выбрать из списка или добавить новый.</p>				</div><div class = 'col-sm-6'>				<label for = 'deviceowner'>Владелец Устройства</label>HTML;			$device->echoComboControl (				'clients',				'SCREEN_NAME',				'-Владелец устройства-',				'deviceowner',				'DeviceData',				$device->ownerID,				0			);			echo <<< HTML			<p class = 'help-block'>Категорию можно выбрать из списка или добавить новый.</p>			<label for = 'devicedescription'>Заметки устройства</label>			<input name = 'devicedescription' type = 'text' id = 'devicedescription' value = '$device->description' autocomplete = 'on' class = 'form-control' placeholder = 'Описание Устройства (полностью)'>			<p class = 'help-block'>Заметки полезны.</p>			</div>			<div class = 'col-sm-12'>			<button form = 'DeviceData' type = 'submit' class = 'btn btn-success center-block'>Сохранить все изменения</button></div>			</form>		</div>	</div></div></div><hr>HTML;			break;		}		case 'edit':		{			$deviceID = $actionAdd;			if (!isset($deviceID))			{				Echo 'No DEVICE ID';				die;			}			if (!isset ($_POST ['devicename']))			{				$device = new Device('DB', $deviceID);			} else			{				$device = new Device('POST', null);				$device->editRecordInDB ($deviceID);				Echo "<script> location.replace('/device/view/$deviceID'); </script>";			}			//************************************************			$checked = ($device->meta) ? 'checked' : '';			echo <<<HTML<div class = 'col-lg-10'>	<div class = 'panel panel-primary'>		<div class = 'panel-heading'>Данные устройства</div>		<div class = 'panel-body'>			<form method = 'post' class = 'form-horizontal' id = 'DeviceData' name = 'DeviceData'			      action = '/device/edit/$deviceID' accept-charset = 'utf-8'			'><div class = 'col-sm-12'>				<label for = 'deviceid'>ID Устройства</label>				<input name = 'deviceid' id = 'deviceid' disabled class = 'form-control' value = '$device->id'>				<p class = 'help-block'>Номер устройства, он же стикер на устройстве.</p></div><div class = 'col-sm-6'>				<label for = 'deviceid'>Название Устройства</label>				<input name = 'devicename' id = 'devicename' autocomplete = 'on' value = '$device->name' class = 'form-control' placeholder = 'Название Устройства (Для определения самого устройства в БД)' required>				<p class = 'help-block'>Название Устройства (Для определения самого устройства в БД).</p>				<label for = 'deviceid'>Изготовитель Устройства</label>				<input name = 'devicemanufac' id = 'devicemanufac' autocomplete = 'on' value = '$device->manufacturerSTR'				       class = 'form-control' placeholder = 'Производитель Устройства' required>				<p class = 'help-block'>Производителя можно выбрать из списка или добавить новый.</p></div><div class = 'col-sm-6'>				<label for = 'deviceid'>Модель устройства</label>				<input name = 'devicemodel' type = 'text' id = 'devicemodel' autocomplete = 'on' value = '$device->modelSTR'				       class = 'form-control' placeholder = 'Модель Устройства' required '>				<p class = 'help-block'>Модель можно выбрать из списка или добавить новый.</p>				<label for = 'deviceid'>Серийный номер устройства</label>				<input name = 'deviceserial' type = 'text' id = 'deviceserial' autocomplete = 'on'				       value = '$device->serial' class = 'form-control'				       placeholder = 'Серийный номер Устройства (полностью)' pattern = '^[0-9a-zA-Z]+$'>				<p class = 'help-block'>Серийный номер проверяется при каждом сохранении.</p></div><div class = 'col-sm-6'>				<label for = 'deviceid'>Тип Устройства</label>				<input name = 'devicetype' type = 'text' id = 'devicetype' value = '$device->typeSTR'				       class = 'form-control' placeholder = 'Тип устройства' required>				<p class = 'help-block'>Тип можно выбрать из списка или добавить новый.</p>				<label for = 'deviceid'>Категория устройства</label>				<input name = 'devicecategory' type = 'text' id = 'devicecategory' autocomplete = 'on'				       value = '$device->categorySTR' class = 'form-control' placeholder = 'Категория устройства'>				<p class = 'help-block'>Категорию можно выбрать из списка или добавить новый.</p>				</div><div class = 'col-sm-6'>				<label for = 'deviceowner'>Владелец Устройства</label>HTML;			$device->echoComboControl (					'clients',					'SCREEN_NAME',					'-Владелец устройства-',					'deviceowner',					'DeviceData',					$device->ownerID,					0			);			echo <<< HTML			<p class = 'help-block'>Категорию можно выбрать из списка или добавить новый.</p>			<label for = 'devicedescription'>Заметки устройства</label>			<input name = 'devicedescription' type = 'text' id = 'devicedescription' value = '$device->description' autocomplete = 'on' class = 'form-control' placeholder = 'Описание Устройства (полностью)'>			<p class = 'help-block'>Заметки полезны.</p>			</div>			<div class = 'col-sm-12'>			<label for = 'devicemeta'>Это устройство временное</label>			<input  name = 'devicemeta' type = 'checkbox' id = 'devicemeta' $checked>			<p class = 'help-block'>Отмечено когда данные устройства сформированы не полностью</p>			<button form = 'DeviceData' type = 'submit' class = 'btn btn-success center-block'>Сохранить все изменения</button></div>			</form>		</div>	</div></div></div><hr>HTML;			break;		}		case 'view':		{			if(isset($_POST['view']))			{				$deviceID = sanitizeString($_POST['view']);			}			else			{				$deviceID = $actionAdd;			}			if ($deviceID)			{				$device = new Device();				$deviceData = $device->getRecordInfo ($deviceID);				echo <<<HTML		<div class="table-responsive"><table class="table table-striped"> <!-- cellspacing='0' is important, must stay -->	<thead>		<tr>			<th>Категория</th>			<th>Даные</th>			<th>Детали</th>		</tr>	</thead>	<tbody>HTML;				echo "<tr><td> Стикер № </td><td><b>" . $deviceData['ID']					. "</b></td></tr>";				echo "<tr><td> Старый стикер № </td><td><i>"					. $deviceData['STICKER'] . "</i></td></tr>";				echo "<tr><td> Устройство</td><td>" . $deviceData['NAME']					. "</td></tr>";				echo "<tr><td> Производитель</td><td>"					. $deviceData['MANUFACTURER'] . "</td></tr>";				echo "<tr><td> Модель</td><td>" . $deviceData['MODEL']					. "</td></tr>";				echo "<tr><td> Серийный №</td><td>" . $deviceData['SERIAL']					. "</td></tr>";				echo "<tr><td> Тип<b></td><td>" . $deviceData['TYPE']					. "</b></td></tr>";				echo "<tr><td> Категория</td><td>" . $deviceData['CATEGORY']					. "</td></tr>";				echo "<tr><td> Последнее изменение</td><td>"					. $deviceData['LAST_EDIT'] . "</td></tr>";				echo "<tr><td> Последнее изменение</td><td>"					. $deviceData['LAST_EDIT'] . "</td></tr>";				echo "<tr><td> Владелец<b></td><td> <a href='/client/view/"					. $deviceData['OWNER_ID'] . "$'>" . $deviceData['OWNER']					. "</a></b></td></tr>";// TODO: /order/new/				echo "<tr><td><a href='/order/new/"					. $deviceData['ID']					. "'> Создать заявку для этого устройства<b></td><td></a></b></td></tr>";				echo <<<HTML	</tbody>	<!-- Table Body --></table></div>HTML;			} else			{				echo <<<HTML<div id = "getDeviceBySticker" class = "overlay">	<div class = "popup">		<h2>Введите Стикер</h2>		<a class = "close" href = "#">×</a>		<form method = "post" action = "/device/view/">			<p><input class = "textboxsticker" type = "number" name = "view" required></p>			<p><input class = "button" type = "submit" value = "Открыть"></p>	</div></div></form>HTML;			}			break;		}		case 'list':		{			$page = $actionAdd;			if (!isset($order))			{				$order = 'ORDER BY ID';			} else			{				$order = 'ORDER BY ' . $order;			}			$query = "SELECT  dev.ID              AS ID,  dev.STICKER         AS STICKER,  dev.NAME            AS NAME,  dev.DESCRIPTION     AS DESCRIPTION,  dev.SERIAL          AS SERIAL,  dev.LAST_EDIT       AS LAST_EDIT,  dev.DELETED         AS DELETED,  dev.META            AS META,  man.NAME            AS MANUFACTURER,  cat.NAME            AS CATEGORY,  modl.NAME           AS MODEL,  typ.NAME            AS TYPE,  cli.SCREEN_NAME     AS OWNER,  dev.OWNER_ID        AS OWNER_IDFROM devices dev  INNER JOIN dev_manufacturer man ON dev.MANUFACTURER_ID = man.ID  INNER JOIN dev_category cat ON dev.CATEGORY_ID = cat.ID  INNER JOIN dev_models modl ON dev.MODEL_ID = modl.ID  INNER JOIN dev_type typ ON dev.TYPE_ID = typ.ID  INNER JOIN clients cli ON dev.OWNER_ID = cli.IDWHERE dev.DELETED = '0'$order";			$result = queryMysql ($query);			if ($result->num_rows)			{				$num = $result->num_rows;							} else			{				Echo 'Error on fetching devices from table';			}			echo <<<HTML<div class = "table-responsive">	<table class = "table table-striped"><!-- cellspacing='0' is important, must stay -->		<thead>		<tr>			<th><a href = "/device/list/$page/order/ID">Стикер</a></th>			<th><a href = "/device/list/$page/order/NAME">Устройство</a></th>			<th><a href = "/device/list/$page/order/MANUFACTURER">Производитель</a></th>			<th><a href = "/device/list/$page/order/MODEL">Модель</a></th>			<th><a href = "/device/list/$page/order/SERIAL">Серийный №</a></th>			<th><a href = "/device/list/$page/order/TYPE">Тип</a></th>			<th><a href = "/device/list/$page/order/OWNER">Владелец</a></th>			<th>Действия</th>		</tr>		</thead>		<tbody>HTML;			for ($j = 0; $j < $num; ++$j)			{				$row = $result->fetch_array (MYSQLI_ASSOC);				if ($j % 2 == 0)				{					$even = " class=\"even\"";				} else				{					$even = '';				}				$id = $row ['ID'];				$name = $row ['NAME'];				$manufacturer = $row ['MANUFACTURER'];				$model = $row ['MODEL'];				$serial = $row ['SERIAL'];				$type = $row ['TYPE'];				$ownerID = $row ['OWNER_ID'];				$owner = $row ['OWNER'];				if ($row['META'])				{					$meta = 'class="danger"';				} else				{					$meta = '';				}				echo <<<HTML<tr $meta>	<td $even><a			href = '/device/view/$id'>$id</a></td>		<td><a href = '/device/view/$id'>$name</a></td>		<td>$manufacturer</td>		<td>$model</td>		<td>$serial</td>		<td>$type</td>		<td><a href = '/client/view/$ownerID'>$owner</td>		<td><a href = "/device/view/$id"><span class="glyphicon glyphicon-list-alt"></span> </a>		<a href = "/device/edit/$id"> <span class="glyphicon glyphicon-pencil"></span></a>		<a href = "/order/new/$id"> <span class="glyphicon glyphicon-wrench"></span></a></td></tr><!-- Table Row -->HTML;			}			echo <<<HTML	</tbody>	<!-- Table Body --></table>HTML;			break;		}		default:		{		}	}}else{	exit;}