<?php/** * Created by PhpStorm. * User: strem * Date: 28.07.2015 * Time: 23:58 */require_once __DIR__ . '/../../Classes/Common/Records.php';require_once __DIR__ . '/../../config.php';class User extends Records{	public $login, $password, $group, $firstName, $lastName, $id, $group_id;	public static function UserReSign()	{		$newsign=md5(date("YmdHisu").rand(1,100));		$_SESSION ['sign'] = $newsign;	}	public function initFromDB ($recordID)	{		if (!isset($this->connection))		{			$this->getConnection ();		}		$result = queryMysql ("SELECT ID,login,username,lastname,group_id FROM users WHERE ID='$recordID'");		if ($result->num_rows)		{			$this->num = $result->num_rows;			$this->row = $result->fetch_array (MYSQLI_ASSOC);			$this->id = $this->row ['ID'];			$this->login = $this->row ['login'];			$this->firstName = $this->row ['username'];			$this->lastName = $this->row ['lastname'];			$this->group_id = $this->row ['group_id'];		} else		{			return 0;		}		return 1;	}	function userLogin ()	{		if ($this->login == "" || $this->password == "")		{			Echo ("<div class='alert alert-danger'><strong>Не полные данные!</strong> Пожалуйста введите логин и пароль.</div>");			return 0;		}		$result = queryMysql ("SELECT * FROM users WHERE login='$this->login'");		if ($result->num_rows)		{			$row = $result->fetch_array (MYSQLI_ASSOC);			$result->close ();			$salt1 = $row['salt1'];			$salt2 = $row['salt2'];			$salt3 = $row['salt3'];			$token = hash ('ripemd128', "$salt1$this->password$salt2$this->password$salt3");			if ($token == $row ['hash'])			{				session_start ();				$_SESSION ['loginId'] = $row['ID'];				$_SESSION ['login'] = $row['login'];				$_SESSION ['firstname'] = $row['username'];				$_SESSION ['lastname'] = $row['lastname'];				$_SESSION ['group'] = $row['group_id'];				User::UserReSign();				makeRecordInHistory ('4', '7', $row['0'], "Выполнен вход пользователя <b>$this->login</b>");				header ("Location:/section/dashboard/view/");				return 1;			}			else			{				Echo ("<div class='alert alert-danger'><strong>Неверный пароль!</strong> Пожалуйста проверьте пароль.</div>");				return 0;			}		}		else		{			Echo ("<div class='alert alert-danger'><strong>Неверный логин!</strong> Пожалуйста проверьте логин.</div>");			return 0;		}	}	function addUserToBase ()	{		$result = queryMysql ("SELECT * FROM users WHERE login='$this->login'");		if ($result->num_rows)		{			echo "Это имя уже занято<br><br>";			return 0;		}		else		{			$salt1 = $this->generateSalt (64);			$salt2 = $this->generateSalt (64);			$salt3 = $this->generateSalt (64);			$token = hash ('ripemd128', "$salt1$this->password$salt2$this->password$salt3");			$result = queryMysql ("INSERT INTO users VALUES(NULL, '$this->login', '$token', '$this->firstName', '$this->lastName' ,'$salt1','$salt2', '$salt3','1')");			if (!$result)			{				Echo ($this->connection->error);			}			return 1;		}	}	private function generateSalt ($max)	{		$characterList = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%&*?";		$i = 0;		$salt = "";		while ($i < $max)		{			$salt .= $characterList{mt_rand (0, (strlen ($characterList) - 1))};			$i++;		}		return $salt;	}	function initFromPOST ()	{		$this->login = sanitizeString ($_POST['username']);		$this->password = sanitizeString ($_POST['password']);		$this->firstName = sanitizeString ($_POST['firstname']);		$this->lastName = sanitizeString ($_POST['lastname']);		return 1;	}	public function echoUserHistory($userID)	{		if (!isset($this->connection))		{			$this->getConnection();		}		$sql = "SELECT ORDER_ID, ORDER_DEVICE_ID, ORDER_DATE, ORDER_NAME, state.STATE, BAGE, PAYED AS PAYED, ORDER_STATE_ID AS STATE_IDFROM orders ordr INNER JOIN order_states state		ON ordr.ORDER_STATE_ID = state.IDWHERE ORDER_TECHNICIAN_ID = '$userID'ORDER BY ORDER_DATE DESCLIMIT 25";		$result = queryMysql($sql);		echo <<<HTML<div class = "panel panel-default">	<div class = "panel-heading">Заявки Пользователя</div>	<div class = "panel-body">		<section id = "tables">			<table class = "table table-bordered table-striped table-hover">				<thead>				<tr>					<th>Дата</th>					<th>№ Заявки</th>					<th>№ Стикера</th>					<th>Имя заявки</th>					<th>Статус заявки</th>				</tr>				</thead>				<tbody>HTML;		for ($j = 0; $j < $result->num_rows; ++$j)		{			$row = $result->fetch_array(MYSQLI_ASSOC);			if($row['PAYED'])			{				$echoPaidStr = '<span class = "label label-success">Оплачена</span>';			}			else			{				if ($row['STATE_ID'] === '2')				{					$echoPaidStr = '<span class = "label label-danger">Не оплачена</span>';				}				else				{					$echoPaidStr = '';				}			}			echo '<tr class="' . $row['BAGE'] . '">        <td>' . showDate(strtotime($row['ORDER_DATE'])) . ' (' . date_format(date_create($row['ORDER_DATE']),			                                                                 'd.m.Y'				) . ')</td>        <td>' . $row['ORDER_ID'] . '</td>        <td><a href="/device/view/' . $row['ORDER_DEVICE_ID'] . '">' . $row['ORDER_DEVICE_ID'] . '</a></td>        <td><a href="/order/view/' . $row['ORDER_ID'] . '">' . $row['ORDER_NAME'] . '</a></td>       <td><span class = "label label-' . $row['BAGE'] . '">' . $row['STATE'] . '</span> '.$echoPaidStr.'</p></td>      </tr>';		}		echo <<<HTML						</tbody>			</table>		</div>	</div>HTML;	}}